generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TipoParticipante {
  JUEZ
  ABOGADO_DEMANDANTE
  ABOGADO_DEFENSOR
  SECRETARIO
  PSICOLOGO
  FORENSE
}

enum EstadoJuicio {
  PROGRAMADO
  EN_CURSO
  COMPLETADO
  CANCELADO
  REAGENDADO
}

enum TipoNotificacion {
  CREACION
  ACTUALIZACION
  RECORDATORIO_24H
  RECORDATORIO_1H
  CANCELACION
}

enum EstadoNotificacion {
  ENVIADO
  ENTREGADO
  LEIDO
}

enum TipoError {
  NOTIFICACION_TELEGRAM_ID_INVALIDO
  NOTIFICACION_BOT_BLOQUEADO
  NOTIFICACION_API_ERROR
  PARTICIPANTE_VALIDACION
  PARTICIPANTE_DUPLICADO
  JUICIO_VALIDACION
  JUICIO_PARTICIPANTE_NO_ENCONTRADO
  TELEGRAM_API_ERROR
  DATABASE_ERROR
  OTRO
}

enum NotificationChannel {
  EMAIL
  TELEGRAM
  BOTH
}

enum MetricStatus {
  PENDING
  SENT
  ACKED
  DELIVERED
  FAILED
}

enum ExperimentScenario {
  LATENCY
  THROUGHPUT
  ERROR_INJECTION
}

enum ExperimentStatus {
  CREATED
  RUNNING
  DONE
  FAILED
}

model Juicio {
  id          String       @id @default(uuid())
  numeroCaso  String       @unique
  tipoJuicio  String
  fecha       DateTime
  hora        String
  sala        String
  descripcion String?
  estado      EstadoJuicio @default(PROGRAMADO)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  participantes  JuicioParticipante[]
  notificaciones Notificacion[]

  @@map("juicios")
}

model Participante {
  id             String           @id @default(uuid())
  nombre         String
  email          String?
  telefono       String?
  tipo           TipoParticipante
  telegramChatId String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  juicios        JuicioParticipante[]
  notificaciones Notificacion[]

  @@map("participantes")
}

model JuicioParticipante {
  id             String   @id @default(uuid())
  juicioId       String
  participanteId String
  rol            String?
  createdAt      DateTime @default(now())

  juicio       Juicio       @relation(fields: [juicioId], references: [id], onDelete: Cascade)
  participante Participante @relation(fields: [participanteId], references: [id], onDelete: Cascade)

  @@unique([juicioId, participanteId])
  @@map("juicio_participantes")
}

model Notificacion {
  id             String             @id @default(uuid())
  juicioId       String
  participanteId String?
  tipo           TipoNotificacion
  mensaje        String
  enviada        Boolean            @default(false)
  fechaEnvio     DateTime?
  estado         EstadoNotificacion @default(ENVIADO)
  messageId      String?
  fechaEntrega   DateTime?
  fechaLectura   DateTime?
  createdAt      DateTime           @default(now())

  juicio       Juicio        @relation(fields: [juicioId], references: [id], onDelete: Cascade)
  participante Participante? @relation(fields: [participanteId], references: [id], onDelete: SetNull)

  @@map("notificaciones")
}

model Auditoria {
  id              String    @id @default(uuid())
  tipoError       TipoError
  entidad         String
  entidadId       String?
  mensaje         String
  detalles        Json?
  stackTrace      String?   @db.Text
  resuelto        Boolean   @default(false)
  fechaResolucion DateTime?
  createdAt       DateTime  @default(now())

  @@index([tipoError])
  @@index([entidad])
  @@index([createdAt])
  @@index([resuelto])
  @@map("auditoria")
}

model NotificationMetricEvent {
  id              String              @id @default(uuid())
  channel         NotificationChannel
  template        String?
  recipientHash   String
  correlationId   String
  status          MetricStatus
  sentAt          DateTime
  providerAckAt   DateTime?
  deliveredAt     DateTime?
  latencyMs       Int?
  errorCode       String?
  errorMessage    String?             @db.Text
  retryCount      Int                 @default(0)
  experimentRunId String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  experimentRun ExperimentRun? @relation(fields: [experimentRunId], references: [id], onDelete: SetNull)

  @@index([channel, createdAt])
  @@index([experimentRunId])
  @@index([status, createdAt])
  @@index([correlationId])
  @@map("notification_metric_events")
}

model ExperimentRun {
  id            String              @id @default(uuid())
  name          String
  description   String?
  scenario      ExperimentScenario
  channelTarget NotificationChannel
  totalMessages Int
  concurrency   Int
  ratePerSec    Int?
  startedAt     DateTime?
  finishedAt    DateTime?
  status        ExperimentStatus    @default(CREATED)
  summaryJson   Json?
  createdBy     String?
  createdAt     DateTime            @default(now())

  metricEvents NotificationMetricEvent[]
  seriesPoints ExperimentSeriesPoint[]

  @@index([status, createdAt])
  @@index([scenario])
  @@map("experiment_runs")
}

model ExperimentSeriesPoint {
  id              String   @id @default(uuid())
  experimentRunId String
  tOffsetSec      Int
  sentCount       Int      @default(0)
  successCount    Int      @default(0)
  failCount       Int      @default(0)
  p95LatencyMs    Int?
  createdAt       DateTime @default(now())

  experimentRun ExperimentRun @relation(fields: [experimentRunId], references: [id], onDelete: Cascade)

  @@index([experimentRunId, tOffsetSec])
  @@map("experiment_series_points")
}
